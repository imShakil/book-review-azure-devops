trigger: 
  - main
pool: 
  name: 'aws-ubuntu'

variables:
  - group: aws-credentials
  - group: terraform-vars

stages:
  - stage: terraformAction
    jobs:
      - job: terraform
        workspace:
          clean: all
        steps:
          - script: |
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set region $(AWS_DEFAULT_REGION)
            displayName: 'Configure AWS CLI'

          - task: DownloadSecureFile@1
            name: download_ssh_key
            inputs:
              secureFile: 'id_rsa.pub'

          - script: |
              echo "Copying SSH public key into Terraform module"
              rm -rf ~/.ssh/
              mkdir -p ~/.ssh
              cp $(download_ssh_key.secureFilePath) ~/.ssh/id_rsa.pub
              ls -la ~/.ssh/
            displayName: 'Extract SSH Public Key for Terraform'
          - script: |
              cat > terraform.tfvars << EOF
              prefix             = "$(TF_PREFIX)"
              rds_name           = "$(TF_RDS_NAME)"
              rds_admin          = "$(TF_RDS_ADMIN)"
              rds_admin_password = "$(TF_RDS_PASSWORD)"
              EOF
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Create terraform.tfvars'
          - script: |
              terraform init
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Terraform Init'
          - script: |
              terraform plan -out=tfplan
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Terraform Plan'
          - script: |
              terraform apply -auto-approve tfplan
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Terraform Apply'
          - script: |
              ls -la
              cat inventory.ini
              ls -la group_vars/
              cat group_vars/rds_info.yml
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Terraform Output'
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/ansible'
              artifact: 'ansible-config'
            displayName: 'Publish Ansible Configuration'
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/terraform/terraform.tfvars'
              artifact: 'terraform.tfvars'
            displayName: 'Publish Terraform vars'

  - stage: ansibleAction
    dependsOn: terraformAction
    condition: succeeded()
    jobs:
      - job: ansible
        steps:
          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: 'ansible-config'
              targetPath: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Download Ansible Configuration'

          - task: DownloadSecureFile@1
            name: download_ssh_key
            inputs:
              secureFile: "id_rsa"

          - script: |
              mkdir -p ~/.ssh
              cp $(download_ssh_key.secureFilePath) ~/.ssh/id_rsa
              chmod 600 ~/.ssh/id_rsa
              echo "StrictHostKeyChecking no" > ~/.ssh/config
            displayName: "Setup SSH Private Key"

          - script: |
              ls -la
              echo "=== Inventory file ==="
              cat inventory.ini
              echo "=== Group vars ==="
              ls -la group_vars/
              cat group_vars/rds_info.yml
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Verify Ansible Files'
          - script: |
              ansible-playbook -i inventory.ini bookreview.yaml --ssh-extra-args "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
            workingDirectory: '$(System.DefaultWorkingDirectory)/ansible'
            displayName: 'Run Ansible Playbook'
            env:
              ANSIBLE_HOST_KEY_CHECKING: "False"


  - stage: destroy
    dependsOn: [terraformAction, ansibleAction]
    condition: and(succeeded('terraformAction'), failed('ansibleAction'))
    jobs:
      - job: destroy
        steps:
          - script: |
              aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
              aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
              aws configure set region $(AWS_DEFAULT_REGION)
            displayName: 'Configure AWS CLI'

          - task: DownloadPipelineArtifact@2
            inputs:
              artifactName: 'terraform.tfvars'
              targetPath: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Download Terraform vars'

          - script: |
              ls -la
              terraform init -upgrade
              terraform destroy -auto-approve
            workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
            displayName: 'Terraform Destroy'

  - stage: manualDestroy
    dependsOn: [terraformAction, ansibleAction]
    condition: and(succeeded('terraformAction'), succeeded('ansibleAction'))
    jobs:
      - deployment: approveDestroy
        environment: 'production-destroy'
        strategy:
          runOnce:
            deploy:
              steps:
                - script: |
                    aws configure set aws_access_key_id $(AWS_ACCESS_KEY_ID)
                    aws configure set aws_secret_access_key $(AWS_SECRET_ACCESS_KEY)
                    aws configure set region $(AWS_DEFAULT_REGION)
                  displayName: 'Configure AWS CLI'
                
                - task: DownloadPipelineArtifact@2
                  inputs:
                    artifactName: 'terraform.tfvars'
                    targetPath: '$(System.DefaultWorkingDirectory)/terraform'
                  displayName: 'Download Terraform vars'

                - script: |
                    ls -la
                    terraform init -upgrade
                    terraform destroy -auto-approve
                  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
                  displayName: 'Manual Destroy'

  - stage: cleanup
    dependsOn: [terraformAction, ansibleAction, destroy]
    condition: and(always(), not(and(succeeded('terraformAction'), succeeded('ansibleAction'))))
    jobs:
      - job: cleanup
        steps:
          - script: |
              rm -f ~/.aws/credentials ~/.aws/config
              rm -rf ~/.ssh
              rm -rf $(System.DefaultWorkingDirectory)/*
            displayName: 'Cleanup Agent'
